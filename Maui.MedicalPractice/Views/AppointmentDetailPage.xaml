<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Maui.MedicalPractice.ViewModels"
             xmlns:models="clr-namespace:Maui.MedicalPractice.Models"
             x:Class="Maui.MedicalPractice.Views.AppointmentDetailPage"
             x:DataType="viewmodels:AppointmentDetailViewModel"
             Title="{Binding Title}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Delete" Command="{Binding DeleteCommand}" IsEnabled="{Binding IsExistingAppointment}" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="12">
            
            <!-- Appointment Details -->
            <Label Text="Appointment Details" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Primary}" />
            
            <Border Padding="12" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="12">
                    
                    <!-- Patient Picker -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Patient *" FontSize="12" TextColor="{StaticResource Gray500}" />
                        <Picker ItemsSource="{Binding Patients}"
                                SelectedItem="{Binding SelectedPatient}"
                                ItemDisplayBinding="{Binding DisplayInfo}"
                                Title="Select Patient" />
                    </VerticalStackLayout>

                    <!-- Physician Picker -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Physician *" FontSize="12" TextColor="{StaticResource Gray500}" />
                        <Picker ItemsSource="{Binding Physicians}"
                                SelectedItem="{Binding SelectedPhysician}"
                                ItemDisplayBinding="{Binding DisplayInfo}"
                                Title="Select Physician" />
                    </VerticalStackLayout>

                    <!-- Date and Time Row -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <Label Text="Date *" FontSize="12" TextColor="{StaticResource Gray500}" />
                            <DatePicker x:Name="AppointmentDatePicker" Date="{Binding AppointmentDate}" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                            <Label Text="Time *" FontSize="12" TextColor="{StaticResource Gray500}" />
                            <Picker ItemsSource="{Binding AvailableTimeSlots}"
                                    SelectedItem="{Binding AppointmentTime}"
                                    Title="Time">
                                <Picker.ItemDisplayBinding>
                                    <Binding StringFormat="{}{0:hh\:mm}" />
                                </Picker.ItemDisplayBinding>
                            </Picker>
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Room Picker (A grade requirement) -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Room *" FontSize="12" TextColor="{StaticResource Gray500}" />
                        <Picker ItemsSource="{Binding AvailableRooms}"
                                SelectedItem="{Binding SelectedRoom}"
                                Title="Select Room" />
                    </VerticalStackLayout>

                    <!-- Status (existing only) -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding IsExistingAppointment}">
                        <Label Text="Status" FontSize="12" TextColor="{StaticResource Gray500}" />
                        <Picker ItemsSource="{Binding StatusOptions}"
                                SelectedItem="{Binding SelectedStatus}"
                                Title="Status" />
                    </VerticalStackLayout>

                    <!-- Notes -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Notes" FontSize="12" TextColor="{StaticResource Gray500}" />
                        <Editor Text="{Binding Notes}"
                                Placeholder="Reason for visit..."
                                HeightRequest="60"
                                AutoSize="TextChanges" />
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Diagnoses Section (A grade requirement) -->
            <VerticalStackLayout Spacing="8" IsVisible="{Binding IsExistingAppointment}">
                <Grid ColumnDefinitions="*,Auto">
                    <Label Grid.Column="0" Text="Diagnoses" FontSize="16" FontAttributes="Bold" 
                           TextColor="{StaticResource Tertiary}" VerticalOptions="Center" />
                    <Button Grid.Column="1" Text="+ Add" Command="{Binding AddDiagnosisCommand}"
                            BackgroundColor="{StaticResource Tertiary}" TextColor="White"
                            Padding="10,4" FontSize="12" CornerRadius="4" />
                </Grid>
                
                <Border Padding="8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8" />
                    </Border.StrokeShape>
                    <CollectionView ItemsSource="{Binding Diagnoses}" HeightRequest="120">
                        <CollectionView.EmptyView>
                            <Label Text="No diagnoses recorded" FontSize="13" TextColor="{StaticResource Gray500}"
                                   HorizontalOptions="Center" Margin="0,20" />
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Diagnosis">
                                <Grid Padding="8,4" ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0" Spacing="2">
                                        <Label Text="{Binding DisplayInfo}" FontSize="14" FontAttributes="Bold" />
                                        <Label Text="{Binding Notes}" FontSize="12" TextColor="{StaticResource Gray500}"
                                               IsVisible="{Binding Notes, Converter={StaticResource StringNotEmptyConverter}}" />
                                    </VerticalStackLayout>
                                    <Button Grid.Column="1" Text="X" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AppointmentDetailViewModel}}, Path=DeleteDiagnosisCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{StaticResource Error}" TextColor="White"
                                            WidthRequest="30" HeightRequest="30" Padding="0" FontSize="12" CornerRadius="4" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Border>
            </VerticalStackLayout>

            <!-- Treatments Section (A grade requirement) -->
            <VerticalStackLayout Spacing="8" IsVisible="{Binding IsExistingAppointment}">
                <Grid ColumnDefinitions="*,Auto,Auto">
                    <Label Grid.Column="0" Text="Treatments" FontSize="16" FontAttributes="Bold" 
                           TextColor="{StaticResource Magenta}" VerticalOptions="Center" />
                    <Label Grid.Column="1" Text="{Binding TotalCostDisplay, StringFormat='Total: {0}'}" 
                           FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Magenta}"
                           VerticalOptions="Center" Margin="0,0,10,0" />
                    <Button Grid.Column="2" Text="+ Add" Command="{Binding AddTreatmentCommand}"
                            BackgroundColor="{StaticResource Magenta}" TextColor="White"
                            Padding="10,4" FontSize="12" CornerRadius="4" />
                </Grid>
                
                <Border Padding="8" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8" />
                    </Border.StrokeShape>
                    <CollectionView ItemsSource="{Binding Treatments}" HeightRequest="120">
                        <CollectionView.EmptyView>
                            <Label Text="No treatments recorded" FontSize="13" TextColor="{StaticResource Gray500}"
                                   HorizontalOptions="Center" Margin="0,20" />
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Treatment">
                                <Grid Padding="8,4" ColumnDefinitions="*,Auto,Auto">
                                    <VerticalStackLayout Grid.Column="0" Spacing="2">
                                        <Label Text="{Binding Name}" FontSize="14" FontAttributes="Bold" />
                                        <Label Text="{Binding Description}" FontSize="12" TextColor="{StaticResource Gray500}"
                                               IsVisible="{Binding Description, Converter={StaticResource StringNotEmptyConverter}}" />
                                    </VerticalStackLayout>
                                    <Label Grid.Column="1" Text="{Binding CostDisplay}" FontSize="14" 
                                           FontAttributes="Bold" TextColor="{StaticResource Success}"
                                           VerticalOptions="Center" Margin="0,0,8,0" />
                                    <Button Grid.Column="2" Text="X" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AppointmentDetailViewModel}}, Path=DeleteTreatmentCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{StaticResource Error}" TextColor="White"
                                            WidthRequest="30" HeightRequest="30" Padding="0" FontSize="12" CornerRadius="4" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Border>
            </VerticalStackLayout>

            <!-- Info Box -->
            <Border Padding="10" StrokeThickness="0" BackgroundColor="{StaticResource Secondary}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="4">
                    <Label Text="Scheduling Rules" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Primary}" />
                    <Label Text="• Mon-Fri, 8 AM - 5 PM" FontSize="11" TextColor="{StaticResource Gray600}" />
                    <Label Text="• No double-booking physicians or rooms" FontSize="11" TextColor="{StaticResource Gray600}" />
                </VerticalStackLayout>
            </Border>

            <!-- Save Button -->
            <Button Text="{Binding IsNewAppointment, Converter={StaticResource BoolToScheduleTextConverter}}"
                    Command="{Binding SaveCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    CornerRadius="8" />

            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" Color="{StaticResource Primary}" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
